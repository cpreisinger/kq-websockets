var app = require("express")();
var http = require("http").Server(app);
var io = require("socket.io")(http);

var fs = require("fs");

// var file = "events.txt"
var file = "events-short-test.txt";

function emitFile(file) {
  fs.readFile(file, "utf8", function(err, content) {
    var lines = content.split("\n");
    console.log(content);

    io.emit("chat message", lines);
  });
  io.emit("chat message", "Test");
}

app.get("/", function(req, res) {
  emitFile(file);
  io.emit("chat message", "Test");
  res.sendFile(__dirname + "/index.html");
});

io.emit("some event", { for: "everyone" });

io.on("connection", function(socket) {
  console.log("a user connected");
  socket.on("chat message", function(msg) {
    console.log("message: ", msg);
    io.emit("chat message", msg);
  });
  socket.on("output events", function(lines) {
    console.log("Output events", lines);
    lines.map(function(line, i) {
      setTimeout(function() {
        io.emit("chat message", line);
      }, 1000 * i);
    });
  });
  socket.on("end of file", function(lines) {
    setTimeout(function() {
      io.emit("chat message", line);
    }, 1000 * i);
  });
});

http.listen(3000, function() {
  console.log("listening on *:3000");
});
